<HTML>
<head>
<title>Crochet Pixel Image Converter</title>

<style>
table, td {
	border: 1px solid black;
	color: fuchsia;
}

p {
	color: gray;
}
</style>

</head>
<body>

<canvas id="canvas" width="100" height="100"></canvas>
<p align="center" class="color-cell" id="hovered-color"></p>
<img id="sourceImage" src="assets/RectoVerso.png">

<div class="slidecontainer">
<input type="range" min="1" max="50" value="15" class="slider" id="sensitivitySlider">
</div>

<button id="dataDisplay" onclick="displayPixelData()"> Display pixel data </button>
<p align="center" id="pixel-grid-data"></p>

<script>
var img = new Image();
img.crossOrigin = 'Anonymous';
img = document.getElementById('sourceImage');
img.src = "assets/RectoVerso.png"
var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');

img.onload = function(){
ctx.drawImage(img,0,0, canvas.width, canvas.height);
img.style.display = 'none';
};


var pixelGrid = [];
var hoveredColor = document.getElementById('hovered-color');

function pick(event, destination) {
	var x = event.clientX;
	var y = event.clientY;
	
	var pixel = ctx.getImageData(x-8,y-8,1,1);
	var data = pixel.data;
	
		const rgba = `rgba(${data[0]}, ${data[1]}, ${data[2]}, ${data[3] / 255})`;
		destination.style.background = rgba;
		destination.textContent = rgba;
		
		console.log(rgba);
		
	return rgba;
}

function getPixelData(){
	
	//var t = document.createElement("TABLE");
	//t.setAttribute("id", "table");
	//document.body.appendChild(t);
	
	
	for (let x=0; x < canvas.width; x++) {
		
		pixelGrid[x] = [];
		
		//var r = document.createElement("TR");
		//r.setAttribute("id", "row" + x);
		//document.getElementById("table").appendChild(r);
		
		for (let y=0; y < canvas.height; y++) {
		
			var pixel = ctx.getImageData(y, x, 1, 1);
			var pixData = pixel.data;
			const rgba = `rgba(${pixData[0]}, ${pixData[1]}, ${pixData[2]}, ${pixData[3] / 255})`;
			
			pixelGrid[x][y] = rgba;
			
			//var c = document.createElement("TD");
			//c.appendChild(document.createTextNode("x: " + x + " y: " + y));
			//c.style.backgroundColor = rgba;
			//document.getElementById("row" + x).appendChild(c);
			
			console.log('x :' + x, 'y :' + y);
		}
	}
	
}

function pixelSameColor(x, y, prevX, prevY) {
	
	var sensitivity = document.getElementById("sensitivitySlider").value;
	
	var currPixel = ctx.getImageData(x, y, 1, 1);
	var currPixData = currPixel.data;
	
	var redValue = currPixData[0];
	var greenValue = currPixData[1];
	var blueValue = currPixData[2];
	
	var prevPixel = ctx.getImageData(prevX, prevY, 1, 1);
	var prevPixData = prevPixel.data;
	
	var prevRedValue = prevPixData[0];
	var prevGreenValue = prevPixData[1];
	var prevBlueValue = prevPixData[2];
	
	if (redValue > (prevRedValue - sensitivity) && redValue < (prevRedValue + sensitivity)) {
		if (greenValue > (prevGreenValue - sensitivity) && greenValue < (prevGreenValue + sensitivity)) {
			if (blueValue > (prevBlueValue - sensitivity) && blueValue < (prevBlueValue + sensitivity)) {
			
			return true;
			
			}
		}
	}
	else {
		return false;
	}
}

function displayPixelData(){

	getPixelData();

	var t = document.createElement("TABLE");
	t.setAttribute("id", "table2");
	document.body.appendChild(t);

	var colorCount = 0;
	var color = "";
	var finalPixel = false;
	
	for (let x = 0; x < canvas.width; x++) {
	
		colorCount = 0;
	
		var r = document.createElement("TR");
		r.setAttribute("id", "row" + x);
		document.getElementById("table2").appendChild(r);
	
		for (let y = 0; y < canvas.height+1; y++) {
			//check if previous colour was the same
			if (!(y == 0)){ //very first pixel in row has no previous pixel
				
				<!-- NEED A METHOD TO GROUP SIMILAR COLOURS -->
				//if R/G/B falls within actual value +/- sensitivity value
				//get previous colour saved locally
				//create boolean sameAsPrevious, which will be set to true if current is within sesitivity values of last colour
				var previousColor = pixelGrid[x][y-1];
				
				if (pixelSameColor(x, y, x, y-1)) {
					//previous pixel was same colour 
					colorCount++;
				}
				else {
					//colour must have changed so record colour count and rgba
					//document.getElementById("pixel-grid-data").innerHTML += ("<br />" + (color + " x" + colorCount));
					
					addToGrid(color, colorCount, x);
					
					//reset count for next colour
					colorCount = 1;
				}
				
			}
			
			else if (x == canvas.width && y == canvas.height) {
				//must be the final pixel
				addToGrid(color, colorCount, x);
				finalPixel = true;
			}
			
			else {
				//must be the first pixel in the row - just increase count and don't compare
				colorCount++;
			}
			
			if (!finalPixel) {color = pixelGrid[x][y]}
			else {return}
		}
	}
}

function addToGrid(color, colorCount, rowNum) {

	var c = document.createElement("TD");
	c.appendChild(document.createTextNode("x" + colorCount));
	c.style.backgroundColor = color;
	document.getElementById("row" + rowNum).appendChild(c);
	
}

canvas.addEventListener('mousemove', function(event) {
	pick(event, hoveredColor);
});

</script>

</body>
</HTML>